from pprint import pprint
from malwareconfig import fileparser

from malwareconfig.yarascanner import YaraScanner
from malwareconfig.modules import __decoders__, __preprocessors__

sample_path = '/home/thehermit/Documents/RATS/blackshades/BlackShadesUPX.exe'


print("[+] Loading Decoders")
for name in __decoders__.keys():
    print("  [-] Loaded: {0}".format(name))

print("[+] Loading PreProcessors")
for name in __preprocessors__.keys():
    print("  [-] Loaded: {0}".format(name))

def load_file(file_path):
    # Open and parse the file
    print("[+] Loading File")
    file_info = fileparser.FileParser(file_path=file_path)
    # Scan with yara
    print("  [-] Scanning File")
    scanner = YaraScanner()
    scanner.yara_scan(file_info.file_data)
    file_info.family_name = scanner.rule_list[0]
    print("  [-] Detected: {0}".format(file_info.family_name))
    return file_info


# Use the yara results to select the correct decoder

file_info = load_file(sample_path)

# First we preprocesss
# Check for a packer we can unpack
if file_info.family_name in __preprocessors__:
    print("  [+] Running PreProcessor {0}".format(file_info.family_name))
    module = __preprocessors__[file_info.family_name]['obj']()
    module.set_file(file_info)
    module.pre_process()


if file_info.family_name in __decoders__:
    print("  [-] Running Decoder")
    module = __decoders__[file_info.family_name]['obj']()
    module.set_file(file_info)
    module.get_config()
    conf = module.config

    print("  [-] Config Output\n")
    pprint(conf)
else:
    print("[!] No Decoder or File is Packed")
