import re
import binascii

from malwareconfig import crypto
from malwareconfig.common import Decoder
from malwareconfig.common import string_printable

prng_seed = 0

class BlackShades(Decoder):
    decoder_name = "BlackShades"
    decoder__version = 1
    decoder_author = "@botnet_hunter, @kevthehermit"
    decoder_description = "BlackShades Decoder"

    def __init__(self):
        self.config = {}

    @staticmethod
    def is_valid_config(config):
        if config[:3] != "\x0c\x0c\x0c":
            return False
        if config.count("\x0C\x0C\x0C") < 15:
            return False
        return True

    @staticmethod
    def get_next_rng_value():
        global prng_seed
        prng_seed = ((prng_seed * 1140671485 + 12820163) & 0xffffff)
        return prng_seed / 65536

    @staticmethod
    def decrypt_configuration(hex):
        global prng_seed

        hex = hex.decode('utf-8')
        ascii = binascii.unhexlify(hex)
        tail = ascii[0x20:]


        pre_check = []
        for x in range(3):
            pre_check.append(tail[x] ^ 0x0c)

        for x in range(0xffffff):
            prng_seed = x
            if BlackShades.get_next_rng_value() != pre_check[0] or BlackShades.get_next_rng_value() != pre_check[1] or BlackShades.get_next_rng_value() != pre_check[2]:
                continue
            prng_seed = x
            config = "".join((chr(ord(c) ^ int(BlackShades.get_next_rng_value())) for c in tail))

            print("Here")
            print(config)

            if BlackShades.is_valid_config(config):
                return config.split("\x0c\x0c\x0c")
        return None

    def extract_config(self):
        file_data = self.file_info.file_data
        config_pattern = re.findall(b'[0-9a-fA-F]{154,}', file_data)
        for s in config_pattern:
            if (len(s) % 2) == 1:
                s = s[:-1]
            return s



    def get_config(self):
        '''
        This is the main entry
        :return:
        '''


        file_data = self.file_info.file_data

        config_data = self.extract_config()

        clear_config = self.decrypt_configuration(config_data)

        print(clear_config)
        config_dict = {}

        # Set the config to the class for use
        self.config = config_dict
